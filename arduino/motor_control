#include<ros.h>
#include <docking/xyInput.h>
#define x_d 5   //cw+
#define x_mm 4  //clk+ 
#define y_d 3   //cw+
#define y_mm 2  //clk+
#define pulse 1000
ros::NodeHandle nh;

using docking::xyInput;


int angle(float degree,char xy){ // 각도로 이동
  if(degree>0)
    digitalWrite(3,HIGH);
  else{
    digitalWrite(3,LOW);
    degree = -1 * degree; 
  }
  float d=200*degree/360;
  for(int i=0;i<d;i++){
    digitalWrite(2,HIGH);//HIGH신호 입력
    delayMicroseconds(pulse);//1000 마이크로초 대기 600~
    digitalWrite(2,LOW);//LOW신호 입력
    delayMicroseconds(pulse);
  }
  return 1;  
}

 int move_mm(int mm,char xy){ // mm 단위로 이동
  if(xy=='y'){   
    if(mm>0)
      digitalWrite(y_d,HIGH);
    else{
      digitalWrite(y_d,LOW);
      mm = -1 * mm; 
    }
    int dy = 100*mm;
    for(int i=0;i<dy;i++)
    {
      digitalWrite(y_mm,HIGH);//HIGH신호 입력
      delayMicroseconds(pulse);//1000 마이크로초 대기 600~
      digitalWrite(y_mm,LOW);//LOW신호 입력
      delayMicroseconds(pulse);
    }
    return 1;
  }
  else if(xy=='x')
  {
    
    if(mm>0)
      digitalWrite(x_d,HIGH);
    else
    {
      digitalWrite(x_d,LOW);
      mm = -1 * mm; 
    }
    int dx = 100*mm;
    for(int i=0;i<dx;i++)
    {
      digitalWrite(x_mm,HIGH);//HIGH신호 입력
      delayMicroseconds(pulse);//1000 마이크로초 대기 600~
      digitalWrite(x_mm,LOW);//LOW신호 입력
      delayMicroseconds(pulse);
    }
    return 1;
 }
}


void callback(const xyInput::Request & req, xyInput::Response & res)
{
      
     float x = req.x;
     float y = req.y;
     bool donex = 0;
     bool doney = 0;
     res.done = 0;
     
     if(x)
     {
        donex = move_mm(x,'x');
     }
     else
     {
        donex = 1;
      }
     if(y)
     {
        doney = move_mm(y,'y'); 
     }
     else
     {
        doney = 1;
     }
   
    if(donex== 1 && doney == 1)
     {
        res.done = 1;
        
     }
     else
     {
       res.done = 0;
     }
     
    
  }

ros::ServiceServer<xyInput::Request, xyInput::Response>server("xy_srv",&callback);

void setup() {
  
  nh.initNode();
  nh.advertiseService(server);

  pinMode(2,OUTPUT);  //for up and down
  pinMode(3,OUTPUT);
  
  pinMode(4,OUTPUT);  //for left and right
  pinMode(5,OUTPUT);
  

}

void loop() {
  
  nh.spinOnce();
  delay(10);
}
